AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Campus Connect -Serverless Backend with JWT Authorizer

Globals:
  Function:
    Timeout: 30
    Runtime: nodejs20.x
    MemorySize: 256
    Environment:
      Variables:
        USERS_TABLE: !Ref UsersTable
        PRODUCTS_TABLE: !Ref ProductsTable
        ORDERS_TABLE: !Ref OrdersTable
        CARTS_TABLE: !Ref CartsTable
        CATEGORIES_TABLE: !Ref CategoriesTable
        SUBCATEGORIES_TABLE: !Ref SubcategoriesTable
        UPLOADS_BUCKET: !Ref UploadsBucket
        CLOUDFRONT_DOMAIN: !GetAtt StaticAssetsDistribution.DomainName
        JWT_SECRET: !Ref JWTSecret
    Tags:
      Environment: !Ref Environment
      Project: campus-connect

Parameters:
  Environment:
    Type: String
    Default: dev2
    AllowedValues: [dev2, dev1, dev, staging, prod]

Resources:
  SharedLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub campus-connect-shared-${Environment}
      Description: Shared dependencies and utilities
      ContentUri: src/layers/shared/
      CompatibleRuntimes:
        - nodejs22.x
        - nodejs20.x
      RetentionPolicy: Delete

  FirebaseServiceAccount:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub campus-connect-firebase-service-${Environment}
      Description: Firebase Service Account for Campus Connect



  JWTAuthorizer:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub campus-connect-jwt-authorizer-${Environment}
      CodeUri: src/functions/auth/
      Handler: authorizer.handler
      Layers:
        - !Ref SharedLayer
      Policies:
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: !Ref JWTSecret

  AuthFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub campus-connect-auth-${Environment}
      CodeUri: src/functions/auth/
      Handler: index.handler
      Layers:
        - !Ref SharedLayer
      Environment:
        Variables:
          FIREBASE_SECRET_ARN: !Ref FirebaseServiceAccount
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - Statement:
            - Effect: Allow
              Action: secretsmanager:GetSecretValue
              Resource: 
                - !Ref JWTSecret
                - !Ref FirebaseServiceAccount
      Events:
        RegisterApi:
          Type: Api
          Properties:
            Path: /auth/register
            Method: post
            RestApiId: !Ref CampusConnectApi
        LoginApi:
          Type: Api
          Properties:
            Path: /auth/login
            Method: post
            RestApiId: !Ref CampusConnectApi
        UpdateProfilePictureApi:
          Type: Api
          Properties:
            Path: /auth/profile/picture
            Method: put
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        LinkFirebaseAccountApi:
          Type: Api
          Properties:
            Path: /auth/firebase/link
            Method: post
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        VerifyFirebaseTokenApi:
          Type: Api
          Properties:
            Path: /auth/firebase/verify
            Method: post
            RestApiId: !Ref CampusConnectApi
        GetUserByIdApi:
          Type: Api
          Properties:
            Path: /auth/user/{id}
            Method: get
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth

  ProductsFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub campus-connect-products-${Environment}
      CodeUri: src/functions/products/
      Handler: index.handler
      Layers:
        - !Ref SharedLayer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ProductsTable
        - DynamoDBReadPolicy:
            TableName: !Ref CategoriesTable
        - DynamoDBReadPolicy:
            TableName: !Ref SubcategoriesTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
        - DynamoDBReadPolicy:
            TableName: !Ref OrdersTable
        - Statement:
            - Effect: Allow
              Action:
                - s3:GetObject
              Resource: !Sub "${UploadsBucket.Arn}/*"
            - Effect: Allow
              Action:
                - s3:ListBucket
              Resource: !GetAtt UploadsBucket.Arn
      Events:
        GetProductsApi:
          Type: Api
          Properties:
            Path: /products
            Method: get
            RestApiId: !Ref CampusConnectApi
        GetProductApi:
          Type: Api
          Properties:
            Path: /products/{id}
            Method: get
            RestApiId: !Ref CampusConnectApi
        DownloadDigitalProductApi:
          Type: Api
          Properties:
            Path: /products/{id}/download
            Method: get
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        GetSellerProductsApi:
          Type: Api
          Properties:
            Path: /products/seller/{id}
            Method: get
            RestApiId: !Ref CampusConnectApi
        CreateProductApi:
          Type: Api
          Properties:
            Path: /products
            Method: post
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        UpdateProductApi:
          Type: Api
          Properties:
            Path: /products/{id}
            Method: put
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        DeleteProductApi:
          Type: Api
          Properties:
            Path: /products/{id}
            Method: delete
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth

  CartFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub campus-connect-cart-${Environment}
      CodeUri: src/functions/cart/
      Handler: index.handler
      Layers:
        - !Ref SharedLayer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref CartsTable
        - DynamoDBReadPolicy:
            TableName: !Ref ProductsTable
      Events:
        GetCartApi:
          Type: Api
          Properties:
            Path: /cart
            Method: get
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        AddToCartApi:
          Type: Api
          Properties:
            Path: /cart
            Method: post
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        AddToCartAltApi:
          Type: Api
          Properties:
            Path: /cart/add
            Method: post
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        UpdateCartItemApi:
          Type: Api
          Properties:
            Path: /cart/{id}
            Method: put
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        RemoveFromCartApi:
          Type: Api
          Properties:
            Path: /cart/{id}
            Method: delete
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        RemoveFromCartAltApi:
          Type: Api
          Properties:
            Path: /cart/remove/{id}
            Method: delete
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        ClearCartApi:
          Type: Api
          Properties:
            Path: /cart/clear
            Method: delete
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth

  OrdersFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub campus-connect-orders-${Environment}
      CodeUri: src/functions/orders/
      Handler: index.handler
      Layers:
        - !Ref SharedLayer
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref OrdersTable
        - DynamoDBReadPolicy:
            TableName: !Ref ProductsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CartsTable
        - DynamoDBReadPolicy:
            TableName: !Ref UsersTable
      Events:
        CreateOrderApi:
          Type: Api
          Properties:
            Path: /orders
            Method: post
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        RequestOrderApi:
          Type: Api
          Properties:
            Path: /orders/request
            Method: post
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        GetOrdersApi:
          Type: Api
          Properties:
            Path: /orders
            Method: get
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        GetSellerOrdersApi:
          Type: Api
          Properties:
            Path: /orders/seller-orders
            Method: get
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        GetMyOrdersApi:
          Type: Api
          Properties:
            Path: /orders/my-orders
            Method: get
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        GetOrderApi:
          Type: Api
          Properties:
            Path: /orders/{id}
            Method: get
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        UpdateOrderStatusApi:
          Type: Api
          Properties:
            Path: /orders/{id}/status
            Method: put
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth

  AdminFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub campus-connect-admin-${Environment}
      CodeUri: src/functions/admin/
      Handler: index.handler
      Layers:
        - !Ref SharedLayer
      Environment:
        Variables:
          PRODUCTS_LAMBDA_ARN: !GetAtt ProductsFunction.Arn
      Policies:
        - DynamoDBCrudPolicy:
            TableName: !Ref ProductsTable
        - DynamoDBCrudPolicy:
            TableName: !Ref CategoriesTable
        - DynamoDBCrudPolicy:
            TableName: !Ref SubcategoriesTable
        - DynamoDBCrudPolicy:
            TableName: !Ref UsersTable
        - Statement:
          - Effect: Allow
            Action: 
              - 'lambda:InvokeFunction'
            Resource: !GetAtt ProductsFunction.Arn
      Events:
        SeedCategoriesApi:
          Type: Api
          Properties:
            Path: /admin/seed/categories
            Method: post
            RestApiId: !Ref CampusConnectApi
        SeedSubcategoriesApi:
          Type: Api
          Properties:
            Path: /admin/seed/subcategories
            Method: post
            RestApiId: !Ref CampusConnectApi
        CleanDuplicatesApi:
          Type: Api
          Properties:
            Path: /admin/clean-duplicates
            Method: post
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        CreateCategoryApi:
          Type: Api
          Properties:
            Path: /admin/categories
            Method: post
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        CreateCategoryOptionsApi:
          Type: Api
          Properties:
            Path: /admin/categories
            Method: options
            RestApiId: !Ref CampusConnectApi
        CreateSubcategoryApi:
          Type: Api
          Properties:
            Path: /admin/subcategories
            Method: post
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        CreateSubcategoryOptionsApi:
          Type: Api
          Properties:
            Path: /admin/subcategories
            Method: options
            RestApiId: !Ref CampusConnectApi
        CleanDuplicatesOptionsApi:
          Type: Api
          Properties:
            Path: /admin/clean-duplicates
            Method: options
            RestApiId: !Ref CampusConnectApi
        GetCategoriesApi:
          Type: Api
          Properties:
            Path: /categories
            Method: get
            RestApiId: !Ref CampusConnectApi
        PublicCreateCategoryApi:
          Type: Api
          Properties:
            Path: /categories
            Method: post
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        GetSubcategoriesApi:
          Type: Api
          Properties:
            Path: /subcategories
            Method: get
            RestApiId: !Ref CampusConnectApi
        PublicCreateSubcategoryApi:
          Type: Api
          Properties:
            Path: /subcategories
            Method: post
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        GetCategorySubcategoriesApi:
          Type: Api
          Properties:
            Path: /categories/{categoryId}/subcategories
            Method: get
            RestApiId: !Ref CampusConnectApi

  UploadFunction:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub campus-connect-upload-${Environment}
      CodeUri: src/functions/upload/
      Handler: getUploadUrl.handler
      Layers:
        - !Ref SharedLayer
      Policies:
        - S3CrudPolicy:
            BucketName: !Ref UploadsBucket
      Events:
        GetUploadUrlApi:
          Type: Api
          Properties:
            Path: /upload/url
            Method: post
            RestApiId: !Ref CampusConnectApi
            Auth:
              Authorizer: JWTAuth
        GetRegistrationUploadUrlApi:
          Type: Api
          Properties:
            Path: /upload/registration/url
            Method: post
            RestApiId: !Ref CampusConnectApi

  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub Users-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: email
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: EmailIndex
          KeySchema:
            - AttributeName: email
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  ProductsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub Products-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: sellerId
          AttributeType: S
        - AttributeName: category
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: SellerIndex
          KeySchema:
            - AttributeName: sellerId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: CategoryIndex
          KeySchema:
            - AttributeName: category
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  OrdersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub Orders-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: userId
          AttributeType: S
        - AttributeName: sellerId
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: UserIndex
          KeySchema:
            - AttributeName: userId
              KeyType: HASH
          Projection:
            ProjectionType: ALL
        - IndexName: SellerIndex
          KeySchema:
            - AttributeName: sellerId
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  CartsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub Carts-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: userId
          AttributeType: S
      KeySchema:
        - AttributeName: userId
          KeyType: HASH

  CategoriesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub Categories-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH

  SubcategoriesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: !Sub Subcategories-${Environment}
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: categoryId
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: CategoryIndex
          KeySchema:
            - AttributeName: categoryId
              KeyType: HASH
          Projection:
            ProjectionType: ALL

  UploadsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: !Sub campus-connect-uploads-${Environment}
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
      CorsConfiguration:
        CorsRules:
          - AllowedHeaders: ['*']
            AllowedMethods: [GET, PUT, POST, DELETE, HEAD]
            AllowedOrigins: ['*']

  StaticAssetsDistribution:
    Type: AWS::CloudFront::Distribution
    Properties:
      DistributionConfig:
        Comment: !Sub "Campus Connect Static Assets - ${Environment}"
        DefaultRootObject: index.html
        Enabled: true
        PriceClass: PriceClass_100
        CustomErrorResponses:
          - ErrorCode: 403
            ResponseCode: 404
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 300
          - ErrorCode: 404
            ResponseCode: 404
            ResponsePagePath: /index.html
            ErrorCachingMinTTL: 300
        Origins:
          - Id: S3Origin
            DomainName: !GetAtt UploadsBucket.RegionalDomainName
            OriginAccessControlId: !Ref OriginAccessControl
            S3OriginConfig: {}
        DefaultCacheBehavior:
          TargetOriginId: S3Origin
          ViewerProtocolPolicy: redirect-to-https
          AllowedMethods: [GET, HEAD, OPTIONS]
          CachedMethods: [GET, HEAD, OPTIONS]
          Compress: true
          CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
          OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf
        CacheBehaviors:
          - PathPattern: "products/*"
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods: [GET, HEAD, OPTIONS]
            CachedMethods: [GET, HEAD, OPTIONS]
            Compress: true
            CachePolicyId: 4135ea2d-6df8-44a3-9df3-4b5a84be39ad
            OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf
          - PathPattern: "profiles/*"
            TargetOriginId: S3Origin
            ViewerProtocolPolicy: redirect-to-https
            AllowedMethods: [GET, HEAD, OPTIONS]
            CachedMethods: [GET, HEAD, OPTIONS]
            Compress: true
            CachePolicyId: 658327ea-f89d-4fab-a63d-7e88639e58f6
            OriginRequestPolicyId: 88a5eaf4-2fd4-4709-b370-b4c650ea3fcf

  OriginAccessControl:
    Type: AWS::CloudFront::OriginAccessControl
    Properties:
      OriginAccessControlConfig:
        Name: !Sub "campus-connect-oac-${Environment}"
        OriginAccessControlOriginType: s3
        SigningBehavior: always
        SigningProtocol: sigv4

  UploadsBucketPolicy:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket: !Ref UploadsBucket
      PolicyDocument:
        Statement:
          - Sid: AllowCloudFrontAccess
            Effect: Allow
            Principal:
              Service: cloudfront.amazonaws.com
            Action: s3:GetObject
            Resource: !Sub "${UploadsBucket.Arn}/*"
            Condition:
              StringEquals:
                AWS:SourceArn: !Sub "arn:aws:cloudfront::${AWS::AccountId}:distribution/${StaticAssetsDistribution}"

  JWTSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub campus-connect-jwt-secret-${Environment}
      Description: JWT Secret for Campus Connect
      GenerateSecretString:
        SecretStringTemplate: '{}'
        GenerateStringKey: 'secret'
        PasswordLength: 64
        ExcludeCharacters: '"@/\'

  CampusConnectApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: !Sub campus-connect-api-${Environment}
      StageName: !Ref Environment
      Cors:
        AllowMethods: "'*'"
        AllowHeaders: "'*'"
        AllowOrigin: "'*'"
        MaxAge: "'86400'"
      GatewayResponses:
        DEFAULT_4XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'*'"
              Access-Control-Allow-Methods: "'*'"
        DEFAULT_5XX:
          ResponseParameters:
            Headers:
              Access-Control-Allow-Origin: "'*'"
              Access-Control-Allow-Headers: "'*'"
              Access-Control-Allow-Methods: "'*'"
      Auth:
        Authorizers:
          JWTAuth:
            FunctionArn: !GetAtt JWTAuthorizer.Arn
            AuthorizerPayloadFormatVersion: "1.0"
            Identity:
              Headers:
                - Authorization
            AuthorizerResultTtlInSeconds: 0

Outputs:
  ApiEndpoint:
    Description: API Gateway endpoint URL
    Value: !Sub "https://${CampusConnectApi}.execute-api.${AWS::Region}.amazonaws.com/${Environment}"
    Export:
      Name: !Sub "${AWS::StackName}-ApiEndpoint"

  CloudFrontDomain:
    Description: CloudFront distribution domain for static assets
    Value: !GetAtt StaticAssetsDistribution.DomainName
    Export:
      Name: !Sub "${AWS::StackName}-CloudFrontDomain"

  CloudFrontDistributionId:
    Description: CloudFront distribution ID
    Value: !Ref StaticAssetsDistribution
    Export:
      Name: !Sub "${AWS::StackName}-CloudFrontDistributionId"

  OriginAccessControlId:
    Description: Origin Access Control ID
    Value: !Ref OriginAccessControl
    Export:
      Name: !Sub "${AWS::StackName}-OriginAccessControlId"

  UsersTableName:
    Description: Users DynamoDB table name
    Value: !Ref UsersTable

  ProductsTableName:
    Description: Products DynamoDB table name
    Value: !Ref ProductsTable

  UploadsBucketName:
    Description: S3 bucket for uploads
    Value: !Ref UploadsBucket